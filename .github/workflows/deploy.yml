name: Deployment CI/CD

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
  pull_request:
    branches: [main]
  push:
    branches:
      - main
      - develop

# Add permissions for artifact access
permissions:
  contents: read
  actions: read

jobs:
  # =============================
  # 1️⃣ Build Job
  # =============================
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine environment from branch
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi
          echo "Detected environment: ${{ steps.set-env.outputs.environment }}"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps
      
      - name: Validate required secrets
        run: |
          ENV="${{ steps.set-env.outputs.environment }}"
          echo "Checking secrets for environment: $ENV"
          
          if [ "$ENV" == "staging" ]; then
            MISSING_SECRETS=()
            [ -z "${{ secrets.APP_URL_STAGING }}" ] && MISSING_SECRETS+=("APP_URL_STAGING")
            [ -z "${{ secrets.API_URL_STAGING }}" ] && MISSING_SECRETS+=("API_URL_STAGING")
            [ -z "${{ secrets.HOST_DNS_STAGING }}" ] && MISSING_SECRETS+=("HOST_DNS_STAGING")
            [ -z "${{ secrets.SERVER_SSH_KEY_STAGING }}" ] && MISSING_SECRETS+=("SERVER_SSH_KEY_STAGING")
            
            if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
              echo "❌ ERROR: Missing required secrets for staging!"
              echo "Missing: ${MISSING_SECRETS[*]}"
              echo ""
              echo "⚠️  IMPORTANT: Add secrets to Repository Secrets, not Environment Secrets!"
              echo "Go to: Settings → Secrets and variables → Actions → New repository secret"
              echo "See .github/SECRETS_TEMPLATE.md for detailed instructions"
              exit 1
            fi
          else
            MISSING_SECRETS=()
            [ -z "${{ secrets.APP_URL_PRODUCTION }}" ] && MISSING_SECRETS+=("APP_URL_PRODUCTION")
            [ -z "${{ secrets.API_URL_PRODUCTION }}" ] && MISSING_SECRETS+=("API_URL_PRODUCTION")
            [ -z "${{ secrets.HOST_DNS_PRODUCTION }}" ] && MISSING_SECRETS+=("HOST_DNS_PRODUCTION")
            [ -z "${{ secrets.SERVER_SSH_KEY_PRODUCTION }}" ] && MISSING_SECRETS+=("SERVER_SSH_KEY_PRODUCTION")
            
            if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
              echo "❌ ERROR: Missing required secrets for production!"
              echo "Missing: ${MISSING_SECRETS[*]}"
              echo ""
              echo "⚠️  IMPORTANT: Add secrets to Repository Secrets, not Environment Secrets!"
              echo "Go to: Settings → Secrets and variables → Actions → New repository secret"
              echo "See .github/SECRETS_TEMPLATE.md for detailed instructions"
              exit 1
            fi
          fi
          echo "✅ All required secrets are configured"
      
      - name: Set environment variables
        run: |
          if [ "${{ steps.set-env.outputs.environment }}" == "staging" ]; then
            echo "NEXT_PUBLIC_APP_URL=${{ secrets.APP_URL_STAGING }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_BASE_URL=${{ secrets.API_URL_STAGING }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_URL=${{ secrets.API_URL_STAGING }}" >> $GITHUB_ENV
          else
            echo "NEXT_PUBLIC_APP_URL=${{ secrets.APP_URL_PRODUCTION }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_BASE_URL=${{ secrets.API_URL_PRODUCTION }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_URL=${{ secrets.API_URL_PRODUCTION }}" >> $GITHUB_ENV
          fi
          # Set common environment variables (with fallbacks for optional secrets)
          echo "NEXT_PUBLIC_TURNSTILE_SITE_KEY=${{ secrets.TURNSTILE_SITE_KEY || '0x4AAAAAACDu5GHln9jdUVp0' }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_CLARITY_PROJECT_ID=${{ secrets.CLARITY_PROJECT_ID || '' }}" >> $GITHUB_ENV
          echo "NODE_ENV=production" >> $GITHUB_ENV
      
      - name: Build Project
        env:
          NEXT_PUBLIC_APP_URL: ${{ steps.set-env.outputs.environment == 'staging' && secrets.APP_URL_STAGING || secrets.APP_URL_PRODUCTION }}
          NEXT_PUBLIC_API_BASE_URL: ${{ steps.set-env.outputs.environment == 'staging' && secrets.API_URL_STAGING || secrets.API_URL_PRODUCTION }}
          NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.TURNSTILE_SITE_KEY || '0x4AAAAAACDu5GHln9jdUVp0' }}
          NEXT_PUBLIC_CLARITY_PROJECT_ID: ${{ secrets.CLARITY_PROJECT_ID }}
          NODE_ENV: production
        run: |
          npm run build
      
      - name: Verify build output
        run: |
          if [ -d "out" ]; then
            echo "Build output found in out/"
            ls -la out/ | head -20
          elif [ -d ".next" ]; then
            echo "Build output found in .next/"
            ls -la .next/ | head -20
          else
            echo "ERROR: No build output directory found!"
            ls -la
            exit 1
          fi
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-lawcentrai-frontend-${{ steps.set-env.outputs.environment }}
          path: out/
          retention-days: 1
          if-no-files-found: error

  # =============================
  # 2️⃣ Deploy Job
  # =============================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Determine environment from branch
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi
          echo "Deploying to: ${{ steps.set-env.outputs.environment }}"
      
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-lawcentrai-frontend-${{ steps.set-env.outputs.environment }}
          path: ./build-output/
      
      - name: Verify downloaded artifact
        run: |
          echo "Contents of build-output:"
          ls -la ./build-output/
      
      - name: Set deployment variables
        run: |
          # Set host
          if [ "${{ steps.set-env.outputs.environment }}" == "staging" ]; then
            echo "DEPLOY_HOST=${{ secrets.HOST_DNS_STAGING }}" >> $GITHUB_ENV
            echo "TARGET_DIR=${{ secrets.TARGET_DIR_STAGING || '/var/www/lawcentrai-apps/frontend/staging' }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_HOST=${{ secrets.HOST_DNS_PRODUCTION }}" >> $GITHUB_ENV
            echo "TARGET_DIR=${{ secrets.TARGET_DIR_PRODUCTION || '/var/www/lawcentrai-apps/frontend/production' }}" >> $GITHUB_ENV
          fi
          
          echo "DEPLOY_USER=deployer" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ steps.set-env.outputs.environment }}" >> $GITHUB_ENV
      
      - name: Validate deployment variables
        run: |
          echo "Validating deployment configuration..."
          
          if [ -z "${{ env.DEPLOY_HOST }}" ]; then
            echo "ERROR: DEPLOY_HOST is empty!"
            echo "Check that HOST_DNS_${{ steps.set-env.outputs.environment }} secret is set"
            exit 1
          fi
          
          if [ -z "${{ env.TARGET_DIR }}" ]; then
            echo "ERROR: TARGET_DIR is empty!"
            exit 1
          fi
          
          echo "✓ Host: ${{ env.DEPLOY_HOST }}"
          echo "✓ User: ${{ env.DEPLOY_USER }}"
          echo "✓ Target: ${{ env.TARGET_DIR }}"
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key directly to file from secret
          if [ "${{ env.ENVIRONMENT }}" == "staging" ]; then
            echo "${{ secrets.SERVER_SSH_KEY_STAGING }}" > ~/.ssh/deploy_key
          else
            echo "${{ secrets.SERVER_SSH_KEY_PRODUCTION }}" > ~/.ssh/deploy_key
          fi
          
          chmod 600 ~/.ssh/deploy_key
          
          # Verify key file exists and has content
          if [ ! -s ~/.ssh/deploy_key ]; then
            echo "ERROR: SSH key file is empty!"
            exit 1
          fi
          
          echo "✓ SSH key written successfully"
          
          # Validate key format
          if grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "✓ SSH key format appears valid"
          else
            echo "WARNING: SSH key may not be in correct format"
            echo "Expected format: -----BEGIN ... PRIVATE KEY-----"
          fi
          
          # Add host to known_hosts
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          if [ $? -eq 0 ]; then
            echo "✓ Host key added to known_hosts"
          else
            echo "WARNING: Could not add host key (this may cause issues)"
          fi
      
      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
            "echo 'SSH connection successful'"
      
      - name: Deploy to server
        run: |
          echo "Deploying to ${{ env.DEPLOY_HOST }}:${{ env.TARGET_DIR }}"
          
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./build-output/ \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.TARGET_DIR }}/
          
          if [ $? -eq 0 ]; then
            echo "✓ Deployment successful"
          else
            echo "ERROR: Deployment failed"
            exit 1
          fi
      
      - name: Set permissions and restart nginx
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
          set -e
          sudo chown -R deployer:www-data ${{ env.TARGET_DIR }}
          sudo chmod -R 755 ${{ env.TARGET_DIR }}
          sudo systemctl restart nginx
          echo "✓ Permissions set and nginx restarted"
          ENDSSH
      
      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "✓ SSH key cleaned up"
      
      - name: Deployment summary
        if: success()
        run: |
          echo "================================"
          echo "Deployment Summary"
          echo "================================"
          echo "Project: lawcentrai-frontend"
          echo "Environment: ${{ steps.set-env.outputs.environment }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Host: ${{ env.DEPLOY_HOST }}"
          echo "Target: ${{ env.TARGET_DIR }}"
          echo "Status: ✓ SUCCESS"
          echo "================================"